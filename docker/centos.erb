FROM pyama/stns:centos-<%= a %>
ENV PATH /root/.rbenv/shims/:$PATH
ENV SERVER_SPEC 1
RUN rpm --rebuilddb; yum install -y yum-plugin-ovl
RUN yum -y install curl sudo rsyslog
ADD . /tmp/stns
WORKDIR /tmp/stns
RUN sed -i "2i auth      sufficient    libpam_stns.so sudo example" /etc/pam.d/sudo
RUN sed -i "4i auth        sufficient    libpam_stns.so" /etc/pam.d/system-auth
RUN sed -i 's/Defaults    requiretty//g' /etc/sudoers
RUN sed -i 's/Defaults    secure_path.*//g' /etc/sudoers
RUN echo '%sudo_example ALL=(ALL) ALL' >> /etc/sudoers
RUN bundle install --path=vendor/bundle --binstubs --gemfile=spec/Gemfile --jobs 4
